<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>История тикетов техподдержки - Доставка</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        :root {
            --primary: #333333;
            --primary-dark: #1a1a1a;
            --accent: #666666;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }
        body {
            padding-top: 4.5rem;
            font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
        }
        .status-open { color: #10b981; font-weight: 600; }
        .status-closed { color: #ef4444; font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 2000;
            transition: all 0.3s ease;
        }
        @media (max-width: 640px) {
            .table-container { overflow-x: auto; }
            .ticket-card { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
<header class="fixed top-0 left-0 w-full bg-white shadow-md border border-gray-200 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-3">
        <a href="/" class="flex items-center space-x-2 text-xl font-bold text-gray-800 hover:text-gray-600">
            <i class="fas fa-headset text-gray-500"></i>
            <span>Доставка - Админ</span>
        </a>
        <div class="flex items-center space-x-4">
            <a href="/admin/chat" class="text-gray-600 hover:text-gray-800 font-medium flex items-center space-x-1">
                <i class="fas fa-comment-dots"></i>
                <span>Активные тикеты</span>
            </a>
            <a href="/" class="text-gray-600 hover:text-gray-800 font-medium flex items-center space-x-1">
                <i class="fas fa-cog"></i>
                <span>Админ панель</span>
            </a>
            <a href="/logout" class="text-gray-600 hover:text-gray-800 font-medium flex items-center space-x-1">
                <i class="fas fa-sign-out-alt"></i>
                <span>Выйти</span>
            </a>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-xl shadow-lg p-6" x-data="{ search: '', statusFilter: '', showToast: false, toastMessage: '', toastType: 'success' }">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">История тикетов техподдержки</h2>
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
            <input type="text" x-model="search" placeholder="Поиск по email..." class="w-full sm:w-1/3 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:outline-none">
            <select x-model="statusFilter" class="w-full sm:w-1/4 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:outline-none">
                <option value="">Все статусы</option>
                <option th:each="status : ${T(com.nzby.homeshop.POJO.SupportTicket.TicketStatus).values()}" th:value="${status}" th:text="${status}"></option>
            </select>
        </div>
        <div class="table-container">
            <table class="w-full border-collapse hidden sm:table">
                <thead>
                <tr class="bg-gray-50">
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ID</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Пользователь</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Дата создания</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Статус</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="ticket : ${tickets}"
                    x-show="search === '' || `${ticket.user.email}`.toLowerCase().includes(search.toLowerCase()) && (statusFilter === '' || `${ticket.status}` === statusFilter)"
                    class="fade-in border-t border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-800" th:text="${ticket.id}"></td>
                    <td class="px-4 py-3 text-sm text-gray-800" th:text="${ticket.user.email}"></td>
                    <td class="px-4 py-3 text-sm text-gray-800" th:text="${#temporals.format(ticket.createdAt, 'dd.MM.yyyy HH:mm')}"></td>
                    <td class="px-4 py-3 text-sm">
                        <span th:classappend="${ticket.status == T(com.nzby.homeshop.POJO.SupportTicket.TicketStatus).OPEN} ? 'status-open' : 'status-closed'" th:text="${ticket.status}"></span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <select class="status-select px-2 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-gray-500 focus:outline-none"
                                    th:attr="data-ticket-id=${ticket.id}"
                                    x-ref="statusSelect"
                                    @change="updateStatus($el)">
                                <option th:each="status : ${T(com.nzby.homeshop.POJO.SupportTicket.TicketStatus).values()}"
                                        th:value="${status}"
                                        th:selected="${ticket.status == status}"
                                        th:text="${status}"></option>
                            </select>
                            <a th:href="@{'/admin/chat/' + ${ticket.id}}" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-comment-dots"></i>
                            </a>
                            <button th:if="${ticket.status == T(com.nzby.homeshop.POJO.SupportTicket.TicketStatus).CLOSED}"
                                    class="text-red-600 hover:text-red-800"
                                    th:attr="data-ticket-id=${ticket.id}"
                                    @click="deleteTicket($event.target)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="sm:hidden flex flex-col space-y-4">
                <div th:each="ticket : ${tickets}"
                     x-show="search === '' || `${ticket.user.email}`.toLowerCase().includes(search.toLowerCase()) && (statusFilter === '' || `${ticket.status}` === statusFilter)"
                     class="fade-in ticket-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-800" th:text="'ID: ' + ${ticket.id}"></span>
                        <div class="flex items-center space-x-2">
                            <a th:href="@{'/admin/chat/' + ${ticket.id}}" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-comment-dots"></i>
                            </a>
                            <button th:if="${ticket.status == T(com.nzby.homeshop.POJO.SupportTicket.TicketStatus).CLOSED}"
                                    class="text-red-600 hover:text-red-800"
                                    th:attr="data-ticket-id=${ticket.id}"
                                    @click="deleteTicket($event.target)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600" th:text="${ticket.user.email}"></div>
                    <div class="text-sm text-gray-600" th:text="${#temporals.format(ticket.createdAt, 'dd.MM.yyyy HH:mm')}"></div>
                    <div class="text-sm">
                        <span th:classappend="${ticket.status == T(com.nzby.homeshop.POJO.SupportTicket.TicketStatus).OPEN} ? 'status-open' : 'status-closed'" th:text="${ticket.status}"></span>
                    </div>
                    <select class="status-select mt-2 w-full px-2 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-gray-500 focus:outline-none"
                            th:attr="data-ticket-id=${ticket.id}"
                            x-ref="statusSelect"
                            @change="updateStatus($el)">
                        <option th:each="status : ${T(com.nzby.homeshop.POJO.SupportTicket.TicketStatus).values()}"
                                th:value="${status}"
                                th:selected="${ticket.status == status}"
                                th:text="${status}"></option>
                    </select>
                </div>
            </div>
            <div th:if="${tickets.isEmpty()}" class="text-center text-gray-500 py-8">
                Нет тикетов в истории.
            </div>
        </div>
        <div class="flex justify-center mt-4" th:if="${totalPages > 1}">
            <a th:href="@{'/admin/ticket-history?page=' + ${currentPage - 1}}" th:if="${currentPage > 0}" class="px-4 py-2 bg-gray-200 rounded-lg mx-1">Предыдущая</a>
            <span class="px-4 py-2 text-gray-600" th:text="${currentPage + 1} + ' / ' + ${totalPages}"></span>
            <a th:href="@{'/admin/ticket-history?page=' + ${currentPage + 1}}" th:if="${currentPage < totalPages - 1}" class="px-4 py-2 bg-gray-200 rounded-lg mx-1">Следующая</a>
        </div>
        <div x-show="showToast" :class="toastType === 'success' ? 'bg-green-500' : 'bg-red-500'" class="toast text-white px-4 py-2 rounded-lg shadow-lg">
            <span x-text="toastMessage"></span>
        </div>
    </div>
</main>

<script defer>
    function updateStatus(select) {
        const ticketId = select.getAttribute('data-ticket-id');
        const status = select.value;
        const statusSpan = select.closest('tr')?.querySelector('span[class*="status-"]') || select.closest('.ticket-card')?.querySelector('span[class*="status-"]');
        const originalValue = select.getAttribute('data-original-value') || select.value;

        if (status === 'CLOSED' && !confirm('Вы уверены, что хотите закрыть тикет?')) {
            select.value = originalValue;
            return;
        }

        select.disabled = true;
        select.insertAdjacentHTML('afterend', '<span class="spinner ml-2"></span>');

        const formData = new FormData();
        formData.append('status', status);

        fetch(`/admin/api/tickets/${ticketId}/update-status`, {
            method: 'POST',
            body: formData,
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error: ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                statusSpan.textContent = data.status;
                statusSpan.className = data.status === 'OPEN' ? 'status-open' : 'status-closed';
                select.setAttribute('data-original-value', data.status);
                Alpine.store('dashboard').showToast = true;
                Alpine.store('dashboard').toastMessage = data.message || 'Статус обновлен!';
                Alpine.store('dashboard').toastType = 'success';
                setTimeout(() => { Alpine.store('dashboard').showToast = false; }, 3000);
            })
            .catch(error => {
                console.error('Error updating status:', error);
                select.value = originalValue;
                Alpine.store('dashboard').showToast = true;
                Alpine.store('dashboard').toastMessage = error.message || 'Ошибка при обновлении статуса';
                Alpine.store('dashboard').toastType = 'error';
                setTimeout(() => { Alpine.store('dashboard').showToast = false; }, 3000);
            })
            .finally(() => {
                select.disabled = false;
                const spinner = select.nextElementSibling;
                if (spinner && spinner.classList.contains('spinner')) {
                    spinner.remove();
                }
            });
    }

    function deleteTicket(button) {
        const ticketId = button.getAttribute('data-ticket-id');
        if (!confirm('Вы действительно хотите удалить тикет ID ' + ticketId + '?')) {
            return;
        }

        button.disabled = true;
        button.insertAdjacentHTML('afterend', '<span class="spinner ml-2"></span>');

        fetch(`/admin/api/tickets/${ticketId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error: ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                const row = button.closest('tr') || button.closest('.ticket-card');
                if (row) {
                    row.remove();
                }
                Alpine.store('dashboard').showToast = true;
                Alpine.store('dashboard').toastMessage = data.message || 'Тикет удалён!';
                Alpine.store('dashboard').toastType = 'success';
                setTimeout(() => { Alpine.store('dashboard').showToast = false; }, 3000);
            })
            .catch(error => {
                console.error('Error deleting ticket:', error);
                Alpine.store('dashboard').showToast = true;
                Alpine.store('dashboard').toastMessage = error.message || 'Ошибка при удалении тикета';
                Alpine.store('dashboard').toastType = 'error';
                setTimeout(() => { Alpine.store('dashboard').showToast = false; }, 3000);
            })
            .finally(() => {
                button.disabled = false;
                const spinner = button.nextElementSibling;
                if (spinner && spinner.classList.contains('spinner')) {
                    spinner.remove();
                }
            });
    }

    document.addEventListener('alpine:init', () => {
        Alpine.store('dashboard', {
            showToast: false,
            toastMessage: '',
            toastType: 'success'
        });
    });
</script>
</body>
</html>