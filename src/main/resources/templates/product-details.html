<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' - Premium Store'">Товар - Premium Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        :root {
            --primary: #333333;
            --primary-dark: #1a1a1a;
            --accent: #666666;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: var(--light);
            overflow-x: hidden;
        }

        header {
            background-color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .logo i {
            color: var(--accent);
        }

        .header-nav {
            display: flex;
            gap: 2rem;
        }

        .header-nav a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            position: relative;
            padding: 0.5rem 0;
            transition: var(--transition);
        }

        .header-nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary);
            transition: var(--transition);
        }

        .header-nav a:hover::after {
            width: 100%;
        }

        .header-nav a:hover {
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .header-actions a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            transition: var(--transition);
            cursor: pointer;
        }

        .header-actions a:hover {
            color: var(--primary);
        }

        .cart-btn {
            position: relative;
            cursor: pointer;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .main-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .product-details {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .product-header {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            width: 100%;
        }

        .product-details h1 {
            font-size: 2rem;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: inline;
        }

        .product-weight {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
            display: inline;
            opacity: 0.7;
        }

        .product-brand {
            font-size: 0.9rem;
            color: var(--gray);
            opacity: 0.7;
        }

        .product-price-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .product-price {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.8rem;
        }

        .product-old-price {
            text-decoration: line-through;
            color: var(--gray);
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        .product-badge {
            background-color: var(--danger);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            display: inline-block;
            vertical-align: middle;
        }

        .carousel {
            flex: 1;
            min-width: 300px;
            border: 2px solid var(--primary);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .carousel-images {
            display: flex;
            transition: transform var(--transition);
        }

        .carousel-image {
            width: 100%;
            height: 350px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .carousel-button:hover {
            background-color: var(--primary);
        }

        .carousel-button.prev {
            left: 10px;
        }

        .carousel-button.next {
            right: 10px;
        }

        .carousel-indicators {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }

        .carousel-indicator {
            width: 10px;
            height: 10px;
            background-color: var(--gray);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .carousel-indicator.active {
            background-color: var(--primary);
        }

        .product-info {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .product-title-price {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .product-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .add-to-cart {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-to-cart.in-cart {
            background-color: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0.6rem 1rem;
        }

        .add-to-cart.in-cart .cart-minus,
        .add-to-cart.in-cart .cart-plus {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .add-to-cart.in-cart .cart-minus:hover,
        .add-to-cart.in-cart .cart-plus:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .add-to-cart.in-cart .cart-quantity {
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .quantity-controls {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .quantity-controls.visible {
            display: flex;
        }

        .quantity-btn {
            background-color: var(--light-gray);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background-color: var(--gray);
            color: white;
        }

        .quantity-display {
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .cart-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .wishlist-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .wishlist-btn:hover {
            color: var(--danger);
        }

        .wishlist-btn.active {
            color: var(--danger);
        }
        .wishlist-btn.active i {
            animation: heart-fill 0.3s ease forwards;
        }

        .wishlist-btn:not(.active) i {
            animation: heart-empty 0.3s ease forwards;
        }

        @keyframes heart-fill {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes heart-empty {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.8);
            }
            100% {
                transform: scale(1);
            }
        }

        .additional-info {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
        }

        .additional-info h3 {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .additional-info .product-info-item {
            padding: 0.5rem 0;
            font-size: 1rem;
            color: var(--gray);
        }

        .category-highlight {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .reviews-section {
            margin-top: 2rem;
            width: 100%;
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .reviews-header h3 {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 700;
        }

        .average-rating {
            font-size: 1.1rem;
            color: var(--gray);
        }

        .review-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .review-item {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: 8px;
            position: relative;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .review-author {
            font-weight: 600;
            color: var(--dark);
        }

        .review-date {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .review-rating {
            color: #f1c40f;
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .review-comment {
            font-size: 1rem;
            color: var(--dark);
        }

        .review-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .review-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .review-image:hover {
            transform: scale(1.05);
        }

        .no-reviews {
            text-align: center;
            color: var(--gray);
            font-size: 1.1rem;
            padding: 1.5rem;
            background-color: var(--light-gray);
            border-radius: 12px;
        }

        .review-form {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--light-gray);
            border-radius: 12px;
        }

        .review-form h4 {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .rating-input {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 1rem;
        }

        .rating-star {
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .rating-star.selected i.fas.fa-star {
            color: #f1c40f;
        }

        .rating-star:hover i.fas.fa-star {
            color: #f1c40f;
        }

        .review-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .review-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .image-upload {
            margin-bottom: 1rem;
        }

        .image-upload input {
            display: block;
            margin-top: 0.5rem;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .submit-review {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .submit-review:hover {
            background-color: var(--primary-dark);
        }

        .recommended-placeholder {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--light-gray);
            border-radius: 12px;
            text-align: center;
            color: var(--gray);
            font-size: 1.1rem;
            width: 100%;
        }

        .error-message {
            background-color: var(--danger);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 500;
            border-left: 5px solid var(--primary-dark);
        }

        .review-vote {
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 10px;
            right: 10px;
        }

        .vote-button {
            background-color: var(--light-gray);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vote-button:hover {
            background-color: var(--gray);
            color: white;
        }

        .vote-count {
            font-weight: bold;
            font-size: 1rem;
            min-width: 20px;
            text-align: center;
        }

        .vote-count.positive {
            color: green;
        }

        .vote-count.neutral {
            color: black;
        }

        .vote-count.negative {
            color: red;
        }

        @media (max-width: 768px) {
            .header-container {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .header-nav {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-actions {
                gap: 1rem;
            }

            .product-details {
                flex-direction: column;
                padding: 1rem;
            }

            .product-header {
                flex-direction: column;
            }

            .carousel {
                height: 200px;
            }

            .carousel-image {
                height: 200px;
            }

            .product-details h1 {
                font-size: 1.5rem;
            }

            .product-actions {
                flex-direction: column;
            }

            .review-image {
                width: 80px;
                height: 80px;
            }

            .product-badge {
                font-size: 0.6rem;
                padding: 0.1rem 0.4rem;
            }
        }

        .review-rating .fas.fa-star {
            color: #6c757d;
        }

        .review-rating .fas.fa-star.selected {
            color: #f1c40f;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90vh;
            margin-top: 5vh;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
        }

        .review-image {
            cursor: pointer;
            max-width: 100px;
            height: auto;
            margin: 5px;
        }
        .review-vote {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vote-button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        .vote-button.active {
            background: #e0e0e0;
            font-weight: bold;
        }

        .vote-count.positive {
            color: green;
        }

        .vote-count.negative {
            color: red;
        }

        .vote-count.neutral {
            color: black;
        }
        /* Стили для рейтинга на странице продукта */
        .product-page-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .product-page-stars-container {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .product-page-star {
            position: relative;
            display: inline-block;
            width: 1.2rem; /* Увеличенный размер для страницы продукта */
            height: 1.2rem;
            color: #1a1a1a;
        }

        .product-page-star i {
            position: absolute;
            top: 0;
            left: 0;
            color: #f1c40f; /* Цвет заполненной звезды (желтый) */
            clip-path: inset(0 calc(100% - (var(--rating) * 100%)) 0 0);
        }

        .product-page-star i.fas.fa-star {
            font-size: 1.2rem; /* Увеличенный размер звезды */
        }

        .product-page-no-rating {
            font-size: 1rem;
            color: var(--gray);
        }

        /* Обеспечиваем согласованность с остальными стилями */
        .product-page-rating span {
            font-size: 1rem;
            color: var(--gray);
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="main-content">
    <div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}">
        Ошибка при загрузке продукта
    </div>

    <div class="product-details">
        <div class="product-header">
            <div class="carousel" x-data="carouselData()" x-init="initCarousel()">
                <div th:if="${product.images == null or product.images.isEmpty()}">
                    <img src="https://via.placeholder.com/600" alt="Нет изображения" class="carousel-image">
                </div>
                <div class="carousel-images" x-ref="images" :style="`transform: translateX(-${currentIndex * 100}%)`"
                     th:unless="${product.images == null or product.images.isEmpty()}">
                    <img th:each="image, imageStat : ${product.images}"
                         th:src="@{'/uploaded-images/' + ${image.filePath}}"
                         th:alt="${product.name} + ' | Изображение ' + ${imageStat.index + 1}"
                         class="carousel-image">
                </div>
                <button class="carousel-button prev" @click="prevSlide" x-show="currentIndex > 0"
                        th:unless="${product.images == null or product.images.isEmpty()}">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-button next" @click="nextSlide" x-show="currentIndex < totalImages - 1"
                        th:unless="${product.images == null or product.images.isEmpty()}">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="carousel-indicators" th:unless="${product.images == null or product.images.isEmpty()}">
                    <span th:each="image, imageStat : ${product.images}"
                          class="carousel-indicator"
                          :class="{ 'active': currentIndex === ${imageStat.index} }"
                          @click="goToSlide(${imageStat.index})"></span>
                </div>
            </div>

            <div class="product-info">
                <div class="product-title-price">
                    <div>
                        <h1 th:text="${product.name}">Название продукта</h1>
                        <span class="product-weight" th:text="${product.weightValue != null ? ' ' + product.weightValue + ' ' + product.weightUnit : ''}"></span>
                    </div>
                    <div class="product-brand" th:text="${product.brand != null ? product.brand : ''}"></div>
                    <div class="product-price-container" th:if="${product.price != null}">
                        <span class="product-price" th:text="${#numbers.formatDecimal(product.discountedPrice != null ? product.discountedPrice.doubleValue() : product.price.doubleValue(), 1, 2)} + ' ₽'"></span>
                        <span class="product-old-price" th:if="${product.discountedPrice != null and product.discountedPrice.compareTo(product.price) < 0}" th:text="${#numbers.formatDecimal(product.price.doubleValue(), 1, 2)} + ' ₽'"></span>
                        <span class="product-badge" th:if="${product.discountPercentage != null and product.discountPercentage > 0}" th:text="'-' + ${product.discountPercentage} + '%'"></span>
                        <span class="product-badge" th:if="${product.status == T(com.nzby.homeshop.POJO.Enum.ProductStatus).NEW}">Новинка</span>
                        <span class="product-badge" th:if="${product.status == T(com.nzby.homeshop.POJO.Enum.ProductStatus).FEATURED}">Рекомендуем</span>
                    </div>
                </div>
                <!-- Обновленные имена классов для рейтинга -->
                <div class="product-page-rating" th:data-product-id="${product.id}">
                    <th:block th:if="${product.averageRating != null and product.averageRating > 0}">
                        <div class="product-page-stars-container">
                            <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                    <span class="product-page-star" th:style="${'--rating: ' + (i <= product.averageRating ? 1 : (i - 1 < product.averageRating ? product.averageRating - (i - 1) : 0))}">
                        <i class="fas fa-star"></i>
                    </span>
                            </th:block>
                        </div>
                        <span th:text="'(' + ${product.ratingsCount != null ? product.ratingsCount : 0} + ')'"></span>
                    </th:block>
                    <th:block th:unless="${product.averageRating != null and product.averageRating > 0}">
                        <span class="product-page-no-rating">Нет отзывов</span>
                    </th:block>
                </div>
                <div class="product-actions">
                    <div class="cart-controls">
                        <button class="add-to-cart" th:data-product-id="${product.id}">
                            <i class="fas fa-cart-plus"></i> В корзину
                        </button>
                        <div class="quantity-controls">
                            <button class="quantity-btn minus"><i class="fas fa-minus"></i></button>
                            <span class="quantity-display">1</span>
                            <button class="quantity-btn plus"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <button class="wishlist-btn" th:data-product-id="${product.id}" th:classappend="${isAuthenticated} ? '' : 'disabled'" th:disabled="${!isAuthenticated}">
                        <i class="far fa-heart"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="additional-info">
            <div th:if="${product.category?.id != null}" class="category-highlight" th:text="${product.category.name}">Птица</div>
            <div th:if="${product.description != null}">
                <h3>Описание</h3>
                <div class="product-info-item" th:text="${product.description}"></div>
            </div>
            <div th:if="${product.features != null}">
                <h3>Характеристики</h3>
                <div class="product-info-item" th:text="${product.features}"></div>
            </div>
            <div th:if="${product.calories != null or product.fats != null or product.proteins != null or product.carbohydrates != null}">
                <h3>Питательная ценность(100г/)</h3>
                <div class="product-info-item">
                    <span th:if="${product.calories != null}" th:text="${product.calories} + ' ккал'"></span>
                    <span th:if="${product.fats != null}" th:text="', Жиры: ' + ${product.fats} + ' г'"></span>
                    <span th:if="${product.proteins != null}" th:text="', Белки: ' + ${product.proteins} + ' г'"></span>
                    <span th:if="${product.carbohydrates != null}" th:text="', Углеводы: ' + ${product.carbohydrates} + ' г'"></span>
                </div>
            </div>
            <div th:if="${product.composition != null}">
                <h3>Состав</h3>
                <div class="product-info-item" th:text="${product.composition}">Состав продукта</div>
            </div>
        </div>

        <div class="reviews-section" style="width: 100%;" th:data-product-id="${product.id}">
            <div class="reviews-header">
                <h3>
                    <a th:href="@{/products/reviews/{id}(id=${product.id})}" style="text-decoration: none; color: inherit;">
                        Отзывы
                    </a>
                </h3>
                <span class="average-rating" th:if="${product.averageRating != null and product.ratingsCount > 0}">
                    Средняя оценка: <span th:text="${#numbers.formatDecimal(product.averageRating, 1, 1)}"></span> (<span th:text="${product.ratingsCount}"></span> отзывов)
                </span>
            </div>

            <div class="review-list" th:if="${reviews != null and !reviews.isEmpty()}">
                <div class="review-item" th:each="review : ${reviews}">
                    <div class="review-header">
                        <span class="review-author" th:text="${review.isAnonymous ? 'Аноним' : (review.user != null ? review.user.name : 'Пользователь')}">Аноним</span>
                        <span class="review-date" th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
                    </div>
                    <div class="review-rating">
                        <span th:text="'Rating: ' + ${review.rating != null ? review.rating : 'null'}" style="display: none;"></span>
                        <i class="fas fa-star" th:each="i : ${#numbers.sequence(1, 5)}"
                           th:classappend="${review.rating != null and review.rating >= i} ? 'selected' : ''"></i>
                    </div>
                    <div class="review-comment" th:text="${review.comment}"></div>
                    <div class="review-images" th:if="${review.images != null and !review.images.isEmpty()}">
                        <img th:each="image : ${review.images}"
                             th:src="@{'/uploaded-images/' + ${image.filePath}}"
                             class="review-image"
                             th:attr="data-modal-src=${'/uploaded-images/' + image.filePath + '?v=1'}"
                             th:alt="'Фото отзыва ' + ${review.id}">
                    </div>
                    <div class="review-vote">
                        <button class="vote-button upvote" th:data-review-id="${review.id}"
                                th:classappend="${userVote[review.id] == 1 ? 'active' : ''}"
                                onclick="voteReview(${review.id}, 1)">+</button>
                        <span class="vote-count" th:text="${voteScores[review.id]}"
                              th:classappend="${voteScores[review.id] > 0 ? 'positive' : voteScores[review.id] < 0 ? 'negative' : 'neutral'}">0</span>
                        <button class="vote-button downvote" th:data-review-id="${review.id}"
                                th:classappend="${userVote[review.id] == -1 ? 'active' : ''}"
                                onclick="voteReview(${review.id}, -1)">-</button>
                    </div>
                </div>
            </div>

            <div id="imageModal" class="modal">
                <span class="modal-close" onclick="closeModal()">×</span>
                <img class="modal-content" id="modalImage">
            </div>

            <div class="no-reviews" th:unless="${reviews != null and !reviews.isEmpty()}">
                Отзывов пока нет. Будьте первым, кто оставит отзыв!
            </div>

            <div class="review-form" x-data="{
                productId: 0,
                rating: 0,
                hoverRating: 0,
                comment: '',
                commentError: '',
                isAnonymous: false,
                images: [],
                isValid: false,

                init() {
                    const productIdAttr = this.$el.closest('.reviews-section').getAttribute('data-product-id');
                    this.productId = parseInt(productIdAttr) || 0;
                    if (!this.productId) {
                        console.error('Product ID not found:', productIdAttr);
                    }
                    this.initRating();
                },

                initRating() {
                    this.rating = 0;
                    this.hoverRating = 0;
                    this.images = [];
                    this.isValid = false;
                },

                setRating(i) {
                    this.rating = i;
                    this.validateForm();
                },

                validateForm() {
                    if (this.comment.length < 3) {
                        this.commentError = 'Отзыв должен содержать минимум 3 символа';
                        this.isValid = false;
                    } else if (this.comment.length > 1000) {
                        this.commentError = 'Отзыв не должен превышать 1000 символов';
                        this.isValid = false;
                    } else {
                        this.commentError = '';
                        this.isValid = this.rating > 0;
                    }
                },

                validateComment(value) {
                    this.comment = value;
                    this.validateForm();
                },

                handleFileUpload(event) {
                    const files = event.target.files;
                    const maxImages = 5;

                    if (this.images.length + files.length > maxImages) {
                        alert(`Максимум ${maxImages} изображений можно прикрепить.`);
                        return;
                    }

                    Array.from(files).forEach(file => {
                        if (!file.type.startsWith('image/')) {
                            alert('Пожалуйста, загрузите только изображения.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.images.push({ file, url: e.target.result });
                        };
                        reader.readAsDataURL(file);
                    });

                    event.target.value = '';
                },

                removeImage(index) {
                    this.images.splice(index, 1);
                },

                async submitReview() {
                    if (!this.productId) {
                        alert('Ошибка: ID продукта не найден');
                        return;
                    }

                    if (!this.isValid) {
                        alert('Пожалуйста, выберите рейтинг и добавьте комментарий (от 3 до 1000 символов).');
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('productId', this.productId);
                        formData.append('rating', this.rating);
                        formData.append('comment', this.comment);
                        formData.append('isAnonymous', this.isAnonymous);

                        this.images.forEach(image => {
                            formData.append('images', image.file);
                        });

                        const response = await fetch('/api/reviews', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            alert('Отзыв успешно добавлен!');
                            window.location.reload();
                        } else {
                            const errorText = await response.text();
                            alert(errorText || 'Ошибка при отправке отзыва.');
                        }
                    } catch (error) {
                        console.error('Ошибка при отправке отзыва:', error);
                        alert('Произошла ошибка при отправке отзыва: ' + error.message);
                    }
                }
            }">
                <h4>Оставить отзыв</h4>
                <div class="rating-input">
                    <template x-for="i in 5" :key="i">
                        <span class="rating-star"
                              :class="{ 'selected': i <= rating || i <= hoverRating }"
                              @click="setRating(i)"
                              @mouseover="hoverRating = i"
                              @mouseout="hoverRating = 0">
                            <i class="fas fa-star"></i>
                        </span>
                    </template>
                </div>
                <div x-show="!rating" style="color: #666; font-size: 0.9rem; margin: 5px 0;">
                    Пожалуйста, поставьте оценку
                </div>

                <textarea class="review-textarea"
                          x-model="comment"
                          placeholder="Напишите ваш отзыв..."
                          @input="validateComment($event.target.value)"></textarea>
                <div x-show="commentError" style="color: #e63946; font-size: 0.9rem; margin-top: 5px;" x-text="commentError"></div>

                <div style="margin: 10px 0;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" x-model="isAnonymous">
                        <span>Оставить отзыв анонимно</span>
                    </label>
                </div>

                <div class="image-upload">
                    <label>Фотографии (необязательно, до 5 штук):</label>
                    <input type="file" accept="image/*" multiple @change="handleFileUpload($event)">
                    <div class="image-preview" x-ref="imagePreview">
                        <template x-for="(image, index) in images" :key="index">
                            <div class="image-preview-item">
                                <img :src="image.url" alt="Preview">
                                <button class="remove-image" @click="removeImage(index)">×</button>
                            </div>
                        </template>
                    </div>
                </div>
                <button class="submit-review"
                        @click="submitReview()"
                        :disabled="!isValid"
                        :style="!isValid ? 'opacity: 0.7;' : ''"
                        x-text="!rating ? 'Поставьте оценку' : !comment || comment.length < 3 ? 'Напишите отзыв' : 'Отправить отзыв'">
                </button>
            </div>

            <div class="recommended-placeholder">
                Здесь будут отображаться рекомендованные продукты
            </div>
        </div>
    </div>
</main>

<script>
    // Модальное окно для изображений
    function openModal(imageSrc) {
        console.log('Открытие модального окна с imageSrc:', imageSrc);
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        if (modal && modalImg) {
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        } else {
            console.error('Модальное окно или элемент изображения не найдены');
        }
    }

    function closeModal() {
        const modal = document.getElementById('imageModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('imageModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // Карусель для Alpine.js
    window.carouselData = function() {
        return {
            currentIndex: 0,
            totalImages: 0,
            autoScroll: null,
            initCarousel() {
                const imagesContainer = this.$refs.images;
                if (imagesContainer) {
                    this.totalImages = imagesContainer.children.length;
                    this.autoScroll = setInterval(() => this.nextSlide(), 5000);
                }
            },
            prevSlide() {
                this.currentIndex = this.currentIndex > 0 ? this.currentIndex - 1 : this.totalImages - 1;
                this.resetAutoScroll();
            },
            nextSlide() {
                this.currentIndex = this.currentIndex < this.totalImages - 1 ? this.currentIndex + 1 : 0;
                this.resetAutoScroll();
            },
            goToSlide(index) {
                this.currentIndex = index;
                this.resetAutoScroll();
            },
            resetAutoScroll() {
                if (this.autoScroll) {
                    clearInterval(this.autoScroll);
                    this.autoScroll = setInterval(() => this.nextSlide(), 5000);
                }
            },
            beforeDestroy() {
                if (this.autoScroll) {
                    clearInterval(this.autoScroll);
                }
            }
        };
    };

    document.addEventListener('DOMContentLoaded', async function() {
        // Инициализация элементов
        const cartButtons = document.querySelectorAll('.add-to-cart');
        const wishlistButtons = document.querySelectorAll('.wishlist-btn');
        const voteButtons = document.querySelectorAll('.vote-button');
        const reviewImages = document.querySelectorAll('.review-image');
        const cartCount = document.querySelector('.cart-count');
        const MAX_QUANTITY = 10;

        let cartItems = [];
        let wishlistItems = [];
        let stockQuantities = {};

        // Инициализация данных
        async function initializeData() {
            try {
                // Корзина
                const cartResponse = await fetch('/api/cart/items', {
                    headers: { 'Accept': 'application/json' }
                });
                if (cartResponse.ok) {
                    cartItems = await cartResponse.json();
                    cartCount.textContent = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                } else {
                    console.warn('Не удалось загрузить корзину:', cartResponse.status);
                    cartCount.textContent = '0';
                }

                // Остатки
                const stockResponse = await fetch('/api/products/stock', {
                    headers: { 'Accept': 'application/json' }
                });
                if (stockResponse.ok) {
                    const stockData = await stockResponse.json();
                    stockData.forEach(item => {
                        stockQuantities[item.productId] = Math.min(item.quantity, MAX_QUANTITY);
                    });
                } else {
                    console.warn('Не удалось загрузить остатки:', stockResponse.status);
                }

                // Вишлист
                const wishlistResponse = await fetch('/user/api/items', {
                    headers: { 'Accept': 'application/json' }
                });
                if (wishlistResponse.ok) {
                    wishlistItems = await wishlistResponse.json();
                } else {
                    console.warn('Не удалось загрузить вишлист:', wishlistResponse.status);
                }
            } catch (error) {
                console.error('Ошибка инициализации данных:', error);
                cartCount.textContent = '0';
            }
        }

        // Инициализация корзины
        async function initializeCartButtons() {
            await initializeData();
            cartButtons.forEach(button => {
                const productId = button.getAttribute('data-product-id');
                if (!productId) {
                    console.warn('Product ID отсутствует на кнопке корзины');
                    return;
                }
                const cartItem = cartItems.find(item => item.productId == productId);
                const available = stockQuantities[productId] !== undefined ? Math.min(stockQuantities[productId], MAX_QUANTITY) : MAX_QUANTITY;
                button.setAttribute('data-max-quantity', available);
                if (cartItem) {
                    updateCartButton(button, {
                        cartItemId: cartItem.id,
                        totalItems: cartItems.reduce((sum, item) => sum + item.quantity, 0),
                        quantity: Math.min(cartItem.quantity, available)
                    });
                }
            });
        }

        // Инициализация вишлиста
        function initializeWishlistButtons() {
            wishlistButtons.forEach(button => {
                const productId = parseInt(button.getAttribute('data-product-id'));
                if (!productId) {
                    console.warn('Product ID отсутствует на кнопке вишлиста');
                    return;
                }
                if (wishlistItems.includes(productId)) {
                    button.classList.add('active');
                    button.querySelector('i').classList.replace('far', 'fas');
                }
            });
        }

        // Обработчики корзины
        function attachCartHandlers() {
            cartButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.preventDefault();
                    if (this.classList.contains('in-cart')) return;
                    const productId = this.getAttribute('data-product-id');
                    const available = parseInt(this.getAttribute('data-max-quantity')) || MAX_QUANTITY;
                    if (available <= 0) {
                        alert('Товара нет в наличии');
                        return;
                    }
                    try {
                        const response = await fetch('/api/cart/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ productId, quantity: 1 })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            updateCartButton(this, data);
                            cartCount.textContent = data.totalItems;
                            this.setAttribute('data-max-quantity', Math.max(available - 1, 0));
                        } else {
                            const errorText = await response.text();
                            alert(errorText || 'Ошибка добавления товара');
                        }
                    } catch (error) {
                        console.error('Ошибка добавления в корзину:', error);
                        alert('Ошибка добавления товара');
                    }
                });
            });

            document.addEventListener('click', async function(e) {
                const target = e.target.closest('.cart-minus') || e.target.closest('.cart-plus');
                if (!target) return;
                e.preventDefault();
                e.stopPropagation();
                const button = target.closest('.add-to-cart');
                const quantityEl = button.querySelector('.cart-quantity');
                const plusBtn = button.querySelector('.cart-plus');
                const currentQuantity = parseInt(quantityEl.textContent);
                const change = target.classList.contains('cart-minus') ? -1 : 1;
                const newQuantity = currentQuantity + change;
                const cartItemId = quantityEl.getAttribute('data-cart-item-id');
                const maxAvailable = parseInt(button.getAttribute('data-max-quantity')) || MAX_QUANTITY;

                if (newQuantity > MAX_QUANTITY) {
                    alert(`Максимум ${MAX_QUANTITY} шт.`);
                    return;
                }

                if (newQuantity < 1) {
                    if (confirm('Удалить из корзины?')) {
                        try {
                            const response = await fetch(`/api/cart/remove?cartItemId=${cartItemId}`, {
                                method: 'DELETE'
                            });
                            if (response.ok) {
                                const data = await response.json();
                                resetCartButton(button, data.totalItems);
                                button.setAttribute('data-max-quantity', maxAvailable + 1);
                            } else {
                                alert('Ошибка удаления товара');
                            }
                        } catch (error) {
                            console.error('Ошибка удаления:', error);
                            alert('Ошибка удаления товара');
                        }
                    }
                } else {
                    try {
                        const response = await fetch('/api/cart/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cartItemId, quantity: newQuantity })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            quantityEl.textContent = data.quantity;
                            cartCount.textContent = data.totalItems;
                            button.setAttribute('data-max-quantity', maxAvailable - change);
                            if (plusBtn) {
                                plusBtn.disabled = data.quantity >= maxAvailable;
                                plusBtn.style.opacity = data.quantity >= maxAvailable ? '0.5' : '1';
                                plusBtn.title = data.quantity >= maxAvailable ? `Максимум: ${maxAvailable} шт.` : '';
                            }
                        } else {
                            const errorText = await response.text();
                            alert(errorText || 'Ошибка обновления количества');
                        }
                    } catch (error) {
                        console.error('Ошибка обновления:', error);
                        alert('Ошибка обновления количества');
                    }
                }
            });
        }

        // Обработчики вишлиста
        function attachWishlistHandlers() {
            wishlistButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.preventDefault();
                    if (this.classList.contains('disabled')) {
                        window.location.href = '/auth/login';
                        return;
                    }
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    if (!productId) {
                        alert('Ошибка: ID продукта не найден');
                        return;
                    }
                    const isActive = this.classList.contains('active');
                    const icon = this.querySelector('i');
                    try {
                        const response = await fetch(`/user/api/${isActive ? 'remove' : 'add'}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ productId })
                        });
                        if (response.ok) {
                            if (isActive) {
                                this.classList.remove('active');
                                icon.classList.replace('fas', 'far');
                                wishlistItems = wishlistItems.filter(id => id !== productId);
                            } else {
                                this.classList.add('active');
                                icon.classList.replace('far', 'fas');
                                wishlistItems.push(productId);
                            }
                        } else {
                            const errorText = await response.text();
                            alert(errorText || `Ошибка ${isActive ? 'удаления' : 'добавления'} в избранное`);
                        }
                    } catch (error) {
                        console.error(`Ошибка ${isActive ? 'удаления' : 'добавления'} в вишлист:`, error);
                        alert('Ошибка');
                    }
                });
            });
        }

        // Обработчики голосования за отзывы
        function attachVoteHandlers() {
            voteButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const reviewId = this.getAttribute('data-review-id');
                    const vote = this.classList.contains('upvote') ? 1 : -1;
                    const isActive = this.classList.contains('active');
                    const voteValue = isActive ? 0 : vote;
                    fetch(`/api/reviews/${reviewId}/vote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `vote=${voteValue}`
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const voteContainer = this.parentElement;
                                const voteCountElement = voteContainer.querySelector('.vote-count');
                                voteCountElement.textContent = data.voteScore;
                                updateVoteCountStyle(voteCountElement, data.voteScore);
                                const upvoteButton = voteContainer.querySelector('.upvote');
                                const downvoteButton = voteContainer.querySelector('.downvote');
                                upvoteButton.classList.toggle('active', data.userVote === 1);
                                downvoteButton.classList.toggle('active', data.userVote === -1);
                            } else {
                                alert(data.message || 'Ошибка голосования');
                            }
                        })
                        .catch(error => {
                            console.error('Ошибка голосования:', error);
                            alert('Ошибка голосования');
                        });
                });
            });
        }

        // Обработчики кликов по изображениям отзывов
        function attachReviewImageHandlers() {
            reviewImages.forEach(image => {
                image.addEventListener('click', function() {
                    const imageSrc = image.getAttribute('data-modal-src');
                    if (imageSrc) {
                        openModal(imageSrc);
                    } else {
                        console.error('Атрибут data-modal-src не найден');
                    }
                });
            });
        }

        // Стили для счетчика голосов
        function updateVoteCountStyle(element, voteScore) {
            element.classList.remove('positive', 'neutral', 'negative');
            if (voteScore > 0) element.classList.add('positive');
            else if (voteScore < 0) element.classList.add('negative');
            else element.classList.add('neutral');
        }

        // Обновление кнопки корзины
        function updateCartButton(button, data) {
            const maxAvailable = parseInt(button.getAttribute('data-max-quantity')) || MAX_QUANTITY;
            const actualQuantity = Math.min(data.quantity || 1, maxAvailable);
            button.classList.add('in-cart');
            button.innerHTML = `
                <span class="cart-text">В корзине</span>
                <button class="cart-minus">-</button>
                <span class="cart-quantity" data-cart-item-id="${data.cartItemId}">${actualQuantity}</span>
                <button class="cart-plus">+</button>
            `;
            const plusBtn = button.querySelector('.cart-plus');
            if (plusBtn) {
                plusBtn.disabled = actualQuantity >= maxAvailable;
                plusBtn.style.opacity = actualQuantity >= maxAvailable ? '0.5' : '1';
                plusBtn.title = actualQuantity >= maxAvailable ? `Максимум: ${maxAvailable} шт.` : '';
            }
        }

        // Сброс кнопки корзины
        function resetCartButton(button, newCartCount) {
            button.classList.remove('in-cart');
            button.innerHTML = '<i class="fas fa-cart-plus"></i> В корзину';
            cartCount.textContent = newCartCount;
        }

        // Инициализация и привязка обработчиков
        await initializeCartButtons();
        initializeWishlistButtons();
        attachCartHandlers();
        attachWishlistHandlers();
        attachVoteHandlers();
        attachReviewImageHandlers();
    });
</script>
</body>
</html>